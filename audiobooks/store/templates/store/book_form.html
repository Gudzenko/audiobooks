{% extends 'store/base.html' %}
{% load static %}
{% load file_tags %}

{% block content %}
<div class="container">
    <div class="mb-4 text-center">
        {% if book and book.image %}
            <img src="{{ book.image.url }}" alt="{{ book.title }}" class="custom-card-img-details img-fluid rounded mb-3">
        {% endif %}
        <h1>{% if book %}Редактировать: {{ book.title }}{% else %}Добавить новую книгу{% endif %}</h1>
    </div>

    <form method="post" enctype="multipart/form-data" class="mt-4">
        {% csrf_token %}
        <input type="hidden" name="action" id="action-field" value="save">

        <div class="card mb-4">
            <div class="card-header">
                <h3 class="mb-0">Основная информация</h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="{{ form.title.id_for_label }}" class="form-label">Название</label>
                    {{ form.title }}
                </div>

                <div class="mb-3">
                    <label for="{{ form.authors.id_for_label }}" class="form-label">Автор(ы)</label>
                    {{ form.authors }}
                </div>

                <div class="mb-3">
                    <label for="{{ form.series.id_for_label }}" class="form-label">Серия</label>
                    {{ form.series }}
                </div>

                <div class="mb-3">
                    <label for="{{ form.genres.id_for_label }}" class="form-label">Жанры</label>
                    {{ form.genres }}
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h3 class="mb-0">Обложка</h3>
            </div>
            <div class="card-body text-center">
                <div id="drop-zone-illustration" class="dropzone border p-3">
                    <div id="preview-illustration">
                        {% if book and book.image %}
                            <img src="{{ book.image.url }}" alt="Обложка" class="img-fluid rounded">
                        {% else %}
                            <span class="text-muted">Перетащите фото сюда или нажмите для выбора</span>
                        {% endif %}
                    </div>
                </div>
                <input type="file" name="illustration" id="id_illustration" class="form-control d-none">
                <input type="hidden" id="clear-input-illustration" name="clear_illustration" value="false">
                <button type="button" id="clear-illustration" class="btn btn-danger mt-3 d-none">Удалить обложку</button>
            </div>
        </div>

        {% if book and book.audio_files.all %}
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="mb-0">Загруженные аудиофайлы</h3>
            </div>
            <div class="card-body">
                <ul class="list-group">
                    {% for audio in book.audio_files.all %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <audio controls class="audio-control">
                            <source src="{{ audio.file.url }}" type="audio/mpeg">
                            Ваш браузер не поддерживает аудиоплеер.
                        </audio>
                        <span class="audio-title">{{ audio.file.name|basename }}</span>
                        <a href="{{ audio.file.url }}" class="btn btn-secondary btn-sm m-2" download>Скачать</a>
                        <button type="button" class="btn btn-danger btn-sm remove-audio m-2" data-audio-id="{{ audio.id }}">Удалить</button>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}

        <div class="card mb-4">
            <div class="card-header">
                <h3 class="mb-0">Добавить аудиофайлы</h3>
            </div>
            <div class="card-body">
                <input type="file" name="audio_files" id="audio_files" class="form-control" multiple>
            </div>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-secondary m-2">
                {% if book %}Сохранить изменения{% else %}Добавить книгу{% endif %}
            </button>
            <a href="{{ previous_page }}" class="btn btn-secondary m-2">Отмена</a>
        </div>
    </form>
</div>

<script src="{% static 'store/js/form_image_preview.js' %}"></script>

{% endblock %}
